apiVersion: batch/v1
kind: Job
metadata:
  name: osrm-server-job
  namespace: experiments
spec:
  template:
    spec:
      containers:
      - name: docker-compose-runner
        image: docker/compose:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            cd /workspace
            
            # Check if data exists
            echo "Checking data availability..."
            ls -la /workspace/data/processed/ | head -5
            
            # Create a temporary directory accessible to both containers
            mkdir -p /tmp/osrm-data
            cp -r /workspace/data/processed/* /tmp/osrm-data/
            echo "Data copied to /tmp/osrm-data/"
            ls -la /tmp/osrm-data/ | head -5
            
            # Override the data path to point to the copied data
            export OSRM_DATA_PATH="/tmp/osrm-data"
            
            docker-compose -f docker-compose.server.yml up -d
            echo "OSRM server started via docker-compose"
            
            # Keep the job running to maintain the container
            while true; do
              sleep 3600
              echo "Job still running to maintain docker-compose services..."
            done
        envFrom:
        - configMapRef:
            name: osrm-env
        env:
        - name: OSRM_DATA_PATH
          value: "/tmp/osrm-data"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
        - name: docker-sock
          mountPath: /var/run/docker.sock
        resources:
          requests:
            cpu: "1"
            memory: "2Gi"
          limits:
            cpu: "5"
            memory: "25Gi"
      volumes:
      - name: workspace
        hostPath:
          path: /infra/k8s-manifests/experiments/osrm
          type: Directory
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock
          type: Socket
      restartPolicy: OnFailure