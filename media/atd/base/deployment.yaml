apiVersion: apps/v1
kind: Deployment
metadata:
  name: atd
spec:
  replicas: 1
  selector:
    matchLabels:
      app: atd
  template:
    metadata:
      labels:
        app: atd
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9091"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: gluetun
        image: ghcr.io/x81k25/automatic-transmission-daemon-vpn:latest
        imagePullPolicy: Always
        resources:
          requests:
            memory: "64Mi"
          limits:
            memory: "1Gi"
        securityContext:
          privileged: true
          capabilities:
            add:
              - NET_ADMIN
        volumeMounts:
        - name: tun-device
          mountPath: /dev/net/tun
        ports:
        - containerPort: 9091
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - wget -q -O- https://ipinfo.io/ip || exit 1
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        env:
        # gluetun static config
        - name: VPN_SERVICE_PROVIDER
          value: "custom"
        - name: VPN_TYPE
          value: "wireguard"
        - name: WIREGUARD_IMPLEMENTATION
          value: "kernelspace"
        - name: DOT
          value: "off"
        - name: VPN_IPV6
          value: "off"
        # wireguard interface (from secret)
        - name: WIREGUARD_PRIVATE_KEY
          valueFrom:
            secretKeyRef:
              name: wireguard-secrets
              key: WIREGUARD_PRIVATE_KEY
        - name: WIREGUARD_ADDRESSES
          value: "10.65.56.151/32"  # TODO: move to secret WIREGUARD_ADDRESS_IPV4
        - name: WIREGUARD_MTU
          valueFrom:
            secretKeyRef:
              name: wireguard-secrets
              key: WIREGUARD_MTU
        # wireguard peer (from secret)
        - name: WIREGUARD_PUBLIC_KEY
          valueFrom:
            secretKeyRef:
              name: wireguard-secrets
              key: WIREGUARD_PUBLIC_KEY
        - name: WIREGUARD_ENDPOINT_IP
          value: "206.217.206.67"  # TODO: move to secret
        - name: WIREGUARD_ENDPOINT_PORT
          value: "51820"  # TODO: move to secret
        - name: WIREGUARD_ALLOWED_IPS
          value: "0.0.0.0/0"  # IPv4 only, no IPv6
        # dns config
        - name: DNS_ADDRESS
          valueFrom:
            secretKeyRef:
              name: wireguard-secrets
              key: WIREGUARD_DNS
      - name: transmission
        image: ghcr.io/x81k25/automatic-transmission-daemon-atd:latest
        imagePullPolicy: Always
        resources:
          requests:
            memory: "128Mi"
          limits:
            memory: "3Gi"
        readinessProbe:
          tcpSocket:
            port: 9091
          initialDelaySeconds: 10
          periodSeconds: 10
        envFrom:
        - configMapRef:
            name: transmission-settings
        env:
        - name: PUID
          value: "1005"
        - name: PGID
          value: "1001"
        - name: TZ
          value: "America/Los_Angeles"
        volumeMounts:
        - name: complete-volume
          mountPath: /media-cache/complete
        - name: incomplete-volume
          mountPath: /media-cache/incomplete
      volumes:
      - name: complete-volume
        hostPath:
          path: /d/media-cache/ENV/complete
          type: DirectoryOrCreate
      - name: incomplete-volume
        hostPath:
          path: /d/media-cache/ENV/incomplete
          type: DirectoryOrCreate
      - name: tun-device
        hostPath:
          path: /dev/net/tun
          type: CharDevice
      dnsPolicy: "None"
      dnsConfig:
        nameservers:
        - 8.8.8.8
        - 8.8.4.4
      imagePullSecrets:
      - name: ghcr-pull-image-secret