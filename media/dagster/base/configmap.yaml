# dagster/base/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: dagster-pipeline-env
  labels:
    app: dagster
data:
  DAGSTER_HOME: "/opt/dagster/dagster_home"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dagster-restart-script
  labels:
    app: dagster
data:
  restart-on-change.sh: |
    #!/bin/bash
    echo "Starting Dagster auto-restart watcher..."
    
    # Wait for git-sync to initialize
    sleep 10
    
    # Get initial symlink target
    LAST_LINK=$(readlink /git-repo/dagstributor 2>/dev/null || echo "none")
    echo "Initial symlink target: $LAST_LINK"
    
    while true; do
      sleep 30  # Check every 30 seconds
      
      # Get current symlink target
      CURRENT_LINK=$(readlink /git-repo/dagstributor 2>/dev/null || echo "none")
      
      if [ "$CURRENT_LINK" != "$LAST_LINK" ] && [ "$CURRENT_LINK" != "none" ]; then
        echo "Git repository updated - symlink changed from $LAST_LINK to $CURRENT_LINK"
        echo "Waiting 10 seconds before restart..."
        sleep 10
        
        echo "Triggering pod restart by terminating dagster-dagit process..."
        # Find and kill the dagster-webserver process to trigger pod restart
        pkill -f "dagster-webserver" || true
        
        LAST_LINK=$CURRENT_LINK
      fi
    done