# dagster/overlays/stg/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: media-stg
resources:
- ../../base
nameSuffix: -stg
commonLabels:
  variant: stg
  environment: stg

images:
- name: 192.168.50.2:5050/media/dagstributor
  newTag: stg

patches:
# Dagster ConfigMap Patch
- patch: |-
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: dagster-pipeline-env
    data:
      DAGSTER_K8S_JOB_IMAGE_PULL_SECRETS: "gitlab-registry"
      DAGSTER_K8S_JOB_SERVICE_ACCOUNT: "dagster-stg"

# Dagster Deployment Patch
- patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: dagster
    spec:
      template:
        spec:
          containers:
          - name: dagster-dagit
            env:
            - name: DAGSTER_K8S_PIPELINE_RUN_NAMESPACE
              value: media-stg
            - name: DAGSTER_K8S_JOB_IMAGE_PULL_SECRETS
              value: "gitlab-registry"
            - name: DAGSTER_K8S_JOB_SERVICE_ACCOUNT
              value: "dagster-stg"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: dagster-secrets
                  key: DAGSTER_MINIO_ACCESS_KEY
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: dagster-secrets
                  key: DAGSTER_MINIO_SECRET_KEY
            - name: DAGSTER_MINIO_ENDPOINT
              value: "http://minio-stg.pgsql:9000"
            resources:
              requests:
                cpu: 10m
                memory: 26Mi
              limits:
                memory: 1.5Gi
                cpu: 500m
          - name: dagster-daemon
            env:
            - name: DAGSTER_K8S_PIPELINE_RUN_NAMESPACE
              value: media-stg
            - name: DAGSTER_K8S_JOB_IMAGE_PULL_SECRETS
              value: "gitlab-registry"
            - name: DAGSTER_K8S_JOB_SERVICE_ACCOUNT
              value: "dagster-stg"
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: dagster-secrets
                  key: DAGSTER_MINIO_ACCESS_KEY
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: dagster-secrets
                  key: DAGSTER_MINIO_SECRET_KEY
            - name: DAGSTER_MINIO_ENDPOINT
              value: "http://minio-stg.pgsql:9000"
            resources:
              requests:
                cpu: 10m
                memory: 26Mi
              limits:
                memory: 1Gi
                cpu: 500m
          volumes:
          - name: dagster-home
            hostPath:
              path: /d/k8s/volumes/dagster/stg/home
              type: DirectoryOrCreate
          - name: dagster-workspace
            hostPath:
              path: /d/k8s/volumes/dagster/stg/workspace
              type: DirectoryOrCreate

# Dagster Instance ConfigMap Patch
- patch: |-
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: dagster-instance
    data:
      dagster.yaml: |
        run_storage:
          module: dagster_postgres.run_storage
          class: PostgresRunStorage
          config:
            postgres_db:
              username:
                env: DAGSTER_PG_USERNAME
              password:
                env: DAGSTER_PG_PASSWORD
              hostname:
                env: DAGSTER_PG_HOST
              port:
                env: DAGSTER_PG_PORT
              db_name:
                env: DAGSTER_PG_DB

        schedule_storage:
          module: dagster_postgres.schedule_storage
          class: PostgresScheduleStorage
          config:
            postgres_db:
              username:
                env: DAGSTER_PG_USERNAME
              password:
                env: DAGSTER_PG_PASSWORD
              hostname:
                env: DAGSTER_PG_HOST
              port:
                env: DAGSTER_PG_PORT
              db_name:
                env: DAGSTER_PG_DB

        event_log_storage:
          module: dagster_postgres.event_log
          class: PostgresEventLogStorage
          config:
            postgres_db:
              username:
                env: DAGSTER_PG_USERNAME
              password:
                env: DAGSTER_PG_PASSWORD
              hostname:
                env: DAGSTER_PG_HOST
              port:
                env: DAGSTER_PG_PORT
              db_name:
                env: DAGSTER_PG_DB

        run_coordinator:
          module: dagster.core.run_coordinator
          class: DefaultRunCoordinator

        run_launcher:
          module: dagster_k8s
          class: K8sRunLauncher
          config:
            job_image: 192.168.50.2:5050/media/dagstributor:stg
            service_account_name: dagster-stg
            job_namespace: media-stg
            instance_config_map: dagster-instance-stg
            image_pull_secrets:
            - name: gitlab-registry
            env_config_maps:
            - environment
            - dagster-config
            - wst-config
            - rear-diff-config
            - reel-driver-config
            - at-config
            - transmission-config
            - dagster-timeout-config-stg
            env_secrets:
            - dagster-secrets
            - wst-secrets
            - rear-diff-secrets
            - reel-driver-secrets
            - at-secrets
            - transmission-secrets
            run_k8s_config:
              job_spec_config:
                ttl_seconds_after_finished: 300
              container_config:
                imagePullPolicy: Always
                resources:
                  requests:
                    cpu: "100m"
                    memory: "512Mi"
                  limits:
                    cpu: "1000m"
                    memory: "2Gi"
                env:
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: dagster-secrets
                      key: DAGSTER_MINIO_ACCESS_KEY
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: dagster-secrets
                      key: DAGSTER_MINIO_SECRET_KEY
                - name: DAGSTER_MINIO_ENDPOINT
                  value: "http://minio-stg.pgsql:9000"

        compute_logs:
          module: dagster_aws.s3.compute_log_manager
          class: S3ComputeLogManager
          config:
            bucket: "media"
            prefix: "dagster/"
            local_dir: "/tmp/dagster-logs"
            endpoint_url:
              env: DAGSTER_MINIO_ENDPOINT
            region: "us-east-1"

        run_monitoring:
          enabled: true
          max_runtime_seconds: 3600
          poll_interval_seconds: 30

# Dagster Service Patch
- target:
    version: v1
    kind: Service
    name: dagster
  patch: |-
    - op: replace
      path: /spec/ports/0/nodePort
      value: 30301